apply from: new File(projectDir.parentFile, 'multiplatform.gradle')
apply from: new File(projectDir.parentFile, 'android_lib.gradle')

//apply plugin: 'kotlin-native-cocoapods'
import org.jetbrains.kotlin.gradle.tasks.FatFrameworkTask

def frameworkName = "kn_rocket"
def frameworkObjCPrefix = 'KN' // rocket

def configureFramework(framework) {
    configure(framework) {
        isStatic = true
        transitiveExport = true
    }
}

kotlin {

    targets {

        println("rocket: iosTargets:" + iosTargets)

        configure(iosTargets) {
            binaries.framework { frame ->
                baseName = frameworkName
                configureFramework(frame)
            }

            binaries {
                def defaultDebugFramework = findFramework('', DEBUG)
                if(defaultDebugFramework != null) {
                    configureFramework(defaultDebugFramework)
                }

                def defaultReleaseFramework = findFramework('', RELEASE)
                if(defaultReleaseFramework != null) {
                    configureFramework(defaultReleaseFramework)
                }
            }

            compilations.main {
                extraOpts '-Xobjc-generics'
                extraOpts '-module-name', frameworkObjCPrefix
            }
        }
    }

    sourceSets {
        commonMain {
            dependencies {
                api KN_FOUNDATION
            }
        }

        androidMain {
            dependencies {
            }
        }

        iosMain {
            dependencies {
            }
        }
    }

//    cocoapods {
//        // Configure fields required by CocoaPods.
//        summary = "Some description for a Kotlin/Native module dif2"
//        homepage = "Link to a Kotlin/Native module homepage dif2"
//    }

    // Create a task building a fat framework.
    task releaseFatFramework(type: FatFrameworkTask) {
        // The fat framework must have the same base name as the initial frameworks.
        baseName = frameworkName

        // The default destination directory is '<build directory>/fat-framework'.
        destinationDir = file("$buildDir/cocoapods/framework")

        def frameworkList = new ArrayList()
        iosTargets.forEach { oneTarget ->
            frameworkList.add(oneTarget.binaries.getFramework("RELEASE"))
        }

        from(frameworkList)
    }

    task iosFatFramework(type: FatFrameworkTask) {
        // The fat framework must have the same base name as the initial frameworks.
        baseName = frameworkName

        String frameworkType = "RELEASE"
        if(iosUseDebugFramework) {
            frameworkType = "DEBUG"
        }
        println("iosFatFrameworkType: $frameworkType")

        // The default destination directory is '<build directory>/fat-framework'.
        destinationDir = file("$buildDir/cocoapods/framework")

        def frameworkList = new ArrayList()
        iosTargets.forEach { oneTarget ->
            frameworkList.add(oneTarget.binaries.getFramework(frameworkType))
        }

        from(frameworkList)
    }
}
